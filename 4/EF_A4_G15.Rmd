---
title: "EF_A4"
output: pdf_document
date: "2025-11-21"
---

```{r exercise1a, echo=TRUE}

library(tidyquant)
library(dplyr)
library(rugarch)
library(PerformanceAnalytics)
library(ggplot2)

symbol <- "HSBC"
start_date <- "2010-11-01"
end_date <- "2020-11-01"

HSBC_data <- tq_get(symbol, get="stock.prices", from=start_date, to=end_date)

HSBC_returns <- HSBC_data %>%
  tq_transmute(select = adjusted, mutate_fun = periodReturn, period="daily", type="arithmetic")

returns_first5y <- HSBC_returns %>% filter(date < "2015-11-01")
returns_last5y <- HSBC_returns %>% filter(date >= "2015-11-01")

spec <- ugarchspec(
  variance.model = list(model="sGARCH", garchOrder=c(1,1)),
  mean.model = list(armaOrder = c(1,0), include.mean = TRUE),
  distribution.model = "norm"
)
ret_vec <- HSBC_returns$daily.returns

# Total sample
T <- length(ret_vec)

# First 5 years length
T1 <- nrow(returns_first5y)

# Rolling estimation for last 5 years
roll <- ugarchroll(
  spec = spec,
  data = ret_vec,
  forecast.length = nrow(returns_last5y),
  refit.every = 250,           
  refit.window = "recursive",
  calculate.VaR = TRUE,
  VaR.alpha = 0.01,
  solver = "hybrid"
)

# Extract computed VaR
VaR_df <- as.data.frame(roll@forecast$VaR)
VaR_001 <- VaR_df[,"alpha(1%)"]

# Attach to last-5-year data
returns_last5y$VaR_001 <- VaR_001

ggplot(returns_last5y, aes(x = date)) +
  geom_line(aes(y = daily.returns, color = "Returns")) +
  geom_line(aes(y = VaR_001, color = "VaR(0.01)")) +
  labs(y = "Returns / VaR", x = "Date") +
  scale_color_manual("", values = c("Returns" = "steelblue", "VaR(0.01)" = "orange")) +
  theme_minimal()
```

```{r Exercise1b, echo=TRUE}

density_df <- as.data.frame(roll@forecast$density)

#colnames(density_df) should be capital letters

mu <- density_df$Mu
sigma <- density_df$Sigma

ES_001 <- mu - sigma * (dnorm(qnorm(0.01)) / 0.01)

returns_last5y$ES_001 <- ES_001

ggplot(returns_last5y, aes(x=date)) +
         geom_line(aes(y=daily.returns, color = "Returns")) +
       geom_line(aes(y=VaR_001, color = "VaR(1%)")) +
         geom_line(aes(y=ES_001, color = "ES(1%)")) +
         scale_color_manual("", values=c("Returns"="steelblue",
                                         "VaR(1%)" = "orange",
                                         "ES(1%)" = "black")) +
         labs(y="Return / VaR / ES", x="date", title = "AR(1)-GARCH(1, 1) VaR(1%) and ES(1%)")
theme_minimal()
```

# Question 2
## a.
```{r echo=TRUE, fig.dim=c(5,4),fig.align='center'}
raw <- read.xlsx('student_groups_stocks.xlsx', sheet = 1)

groupNumber <- 15
nameOfStock <- raw$Stock.Name[groupNumber]
startDate <- raw$Start.Date[groupNumber]
endDate <- raw$`End.Date.(+10y)`[groupNumber]

# compute the start date of the final five years
originalDate <- as.Date(startDate)
endDate_fiveYears <- originalDate %m+% years(5)

# extract the daily stock price from source
getSymbols(nameOfStock, src = 'yahoo', from = startDate, to = endDate)

# extract the data of first five years
firstFiveYear <- window(HSBC, start = startDate, end = endDate_fiveYears)

# extract the Adjusted Close for the first five years
adjustedPrice_firstFiveYears<- as.numeric(firstFiveYear[,'HSBC.Adjusted'])

compute_simpleReturns <- function(input_priceSeries){
  result <- numeric(length(input_priceSeries) - 1)
  
  for(i in (2:length(input_priceSeries))){
    result[i-1] <- (input_priceSeries[i] - input_priceSeries[i-1]) / 
                    input_priceSeries[i-1]
  }
  
  return(result)
}

# compute the Daily Simple Returns for the first five years
simpleReturns_firstFiveYears <- compute_simpleReturns(adjustedPrice_firstFiveYears)

# extract the data of last five years
lastFiveYear <- window(HSBC, start = endDate_fiveYears, end = endDate)
date_lastFiveYear <- index(lastFiveYear)

# extract the Adjusted Close for the next five years
adjustedPrice_lastFiveYears<- as.numeric(lastFiveYear[,'HSBC.Adjusted'])

# compute the Daily Simple Returns for the next five years
simpleReturns_lastFiveYears <- compute_simpleReturns(adjustedPrice_lastFiveYears)

probability <- 0.01
window <- 3/probability

#choose the min and max date and two random ones
firstDate <- returns_last5y$date[which.min(returns_last5y$daily.returns)]
secondDate <- returns_last5y$date[which.max(returns_last5y$daily.returns)]
thirdDate <- returns_last5y$date[400]
fourthDate <- returns_last5y$date[900]

valueAtRisk_NonParametric <- function(input_startDate, input_window, input_probability){
  this_endDate <- as.Date(input_startDate) %m+% days(input_window)
  duration <- window(HSBC, start = input_startDate, end = this_endDate)
  
  # extract the Adjusted Close for the next five years
  this_adjustedPrice <- as.numeric(duration[,'HSBC.Adjusted'])
  
  this_simpleReturns <- compute_simpleReturns(this_adjustedPrice)
  sorted_this_simpleReturns <- sort(this_simpleReturns)
  
  this_VaR <- -sorted_this_simpleReturns[input_window*input_probability]
  
  return(this_VaR)
}

# compute the VaR using Non-Parametric Approach
first_VaR <- valueAtRisk_NonParametric(firstDate, window, probability)
second_VaR <- valueAtRisk_NonParametric(secondDate, window, probability)
third_VaR <- valueAtRisk_NonParametric(thirdDate, window, probability)
fourth_VaR <- valueAtRisk_NonParametric(fourthDate, window, probability)

nonParametric_VaR_df = data.frame(Date = c(firstDate, 
                                           secondDate, 
                                           thirdDate, 
                                           fourthDate),
                                  VaR_0.01 = c(first_VaR, 
                                               second_VaR, 
                                               third_VaR, 
                                               fourth_VaR))
nonParametric_VaR_df
```

## b.
```{r echo=TRUE, fig.dim=c(5,4), fig.align='center'}
expectedShortfall_NonParametric <- function(input_startDate, input_window, input_probability){
  this_endDate <- as.Date(input_startDate) %m+% days(input_window)
  duration <- window(HSBC, start = input_startDate, end = this_endDate)
  
  # extract the Adjusted Close for the duration
  this_adjustedPrice <- as.numeric(duration[,'HSBC.Adjusted'])
  
  this_simpleReturns <- compute_simpleReturns(this_adjustedPrice)
  sorted_this_simpleReturns <- sort(this_simpleReturns)
  
  this_VaR <- -sorted_this_simpleReturns[input_window*input_probability]
  this_ES <- -mean(sorted_this_simpleReturns[1:floor(input_window*input_probability)])
  
  return(this_ES)
}

# compute the ES using Non-Parametric Approach
first_ES <- expectedShortfall_NonParametric(firstDate, window, probability)
second_ES <- expectedShortfall_NonParametric(secondDate, window, probability)
third_ES <- expectedShortfall_NonParametric(thirdDate, window, probability)
fourth_ES <- expectedShortfall_NonParametric(fourthDate, window, probability)

nonParametric_risk_df = data.frame(Date = c(firstDate, 
                                            secondDate, 
                                            thirdDate, 
                                            fourthDate),
                                   VaR_0.01 = c(first_VaR, 
                                                second_VaR, 
                                                third_VaR, 
                                                fourth_VaR),
                                   ES_0.01 = c(first_ES, 
                                                second_ES, 
                                                third_ES, 
                                                fourth_ES))
nonParametric_risk_df
```

