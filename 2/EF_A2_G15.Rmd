---
title: "EF Group Submission Assignment 2"
subtitle: "Group 15" 
author: "Lanlan Hou (2801069), Rick van der Ploeg (2782774), Sebastiaan van Dijen (2769505) and Alfred Sou (2796840)"
output: pdf_document
---

# Question 1

## a.
```{r echo=TRUE,fig.dim=c(5,4),fig.align='center'}
library(openxlsx)
raw <- read.xlsx('student_groups_stocks.xlsx', sheet = 1)

groupNumber <- 15
nameOfStock <- raw$Stock.Name[groupNumber]
startDate <- raw$Start.Date[groupNumber]
endDate <- raw$`End.Date.(+10y)`[groupNumber]

# Compute the start date of the final five years
library(lubridate)

originalDate <- as.Date(startDate)
finalFiveYearsStartDate <- originalDate %m+% years(5)

# Extract the daily stock price from source
library(quantmod)

getSymbols(nameOfStock, src = 'yahoo', from = finalFiveYearsStartDate, to = endDate)
date <- index(HSBC)

# Adjusted Close
adjustedPrice <- as.numeric(HSBC[,'HSBC.Adjusted'])

# Log Returns
compoundedReturns <- numeric(length(adjustedPrice) - 1)
for(i in (2:length(adjustedPrice))){
  compoundedReturns[i-1] <- log(adjustedPrice[i] / adjustedPrice[i-1])
}
# Squared Log Returns
squaredCompoundedReturns <- compoundedReturns ^ 2

# Function to compute the ACF and plot the graph
plotACF <- function(input_list, input_maxLags, objectName, savePath) {
  ACFResult <- acf(input_list, lag.max = input_maxLags, plot = FALSE)
  
  ACFValues <- ACFResult$acf[-1]
  lags <- ACFResult$lag[-1]
  numberOfObservations <- length(input_list)
  confidenceBands <- 1.96 * 1 / sqrt(length(input_list))
  
  library(ggplot2)
  plot_df <- data.frame(lag = lags, acf = ACFValues)
  
  ggplot(plot_df, aes(x = lag, y = acf)) +
    geom_bar(aes(color = 'ACF'), stat = 'identity', 
             fill ='blue', width = 0.05) +
    geom_hline(yintercept = 0, color = 'black') +
    geom_hline(aes(yintercept = -confidenceBands, 
               color = '95% Confidence Interval'), linetype = 'dashed') + 
    geom_hline(aes(yintercept = confidenceBands, 
               color = '95% Confidence Interval'), linetype = 'dashed') +
    scale_color_manual(name = 'Components',
                       values = c('ACF' = 'blue',
                                  '95% Confidence Interval' = 'red')) +
    labs(title = paste('ACF for HSBC', objectName, 'for', input_maxLags, 'Lags (2015M11-2020M11)'), 
         x = 'Lag', y = 'ACF') +
    theme_minimal() +
    theme(legend.position = c(0.95, 0.95),
          legend.justification = c("right", "top"),
          legend.title = element_text(size = 12, face = "bold"),
          legend.text = element_text(size = 10))
  ggsave(savePath, width = 10, height = 6, dpi = 300)
}

returns_result <- plotACF(compoundedReturns, 
                  input_maxLags = 50,
                  objectName = 'Log Returns', 
                  savePath = 'figures/returns_acf_plot.png')

squaredReturns_result <- plotACF(squaredCompoundedReturns, 
                                 input_maxLags = 50,
                                 objectName = 'Squared Log Returns', 
                                 savePath = 'figures/squaredReturns_acf_plot.png')
```

## b.
```{r echo=TRUE,fig.dim=c(5,4),fig.align='center'}
# Function to perform the Ljung-Box test and report the result
LBTest <- function(input_series, input_maxLags, steps){
  steppedLags <- seq(steps, input_maxLags, by = steps)
  
  result_df <- data.frame(Lag = integer(),
                          Statistic = numeric(),
                          Crit_Value = numeric(),
                          P_Value = numeric())
  
  for (lag in steppedLags) {
    lb_test <- Box.test(input_series, lag = lag, type = 'Ljung-Box')
    testStatistic <- as.numeric(lb_test$statistic)
    pValue <- as.numeric(lb_test$p.value)
    criticalValue <- qchisq(0.95, df = lag)
  
    newRow <- data.frame(Lag = lag, 
                         Statistic = round(testStatistic, 4),
                         Critical_Value = round(criticalValue, 4),
                         P_Value = signif(pValue, 4))
    
    result_df <- rbind(result_df,newRow)
  }
  return(result_df)
}

returns_LBTest <- LBTest(compoundedReturns, 50, 10)
returns_LBTest
returns_LBTest <- LBTest(squaredCompoundedReturns, 50, 10)
returns_LBTest
```

# Question 2

## a.
```{r echo=TRUE, fig.dim=c(5,4),fig.align='center'}

library(tidyquant)
library(dplyr)
library(ggplot2)
library(forecast)
library(zoo)

setwd("~/Downloads/EF_A2")

# windows
W <- 21

# getting data
HSBC_data <- tq_get("HSBC", get = "stock.prices", from = "2016-11-01", to = "2020-11-01")


# log returns
HSBC_data <- HSBC_data %>%
  mutate(log_return = log(adjusted / lag(adjusted))) %>%
  filter(!is.na(log_return))

# MA volatility
HSBC_data <- HSBC_data %>%
  mutate(MA_vol = rollapply(log_return, width = W, FUN = sd, align = "right", fill = NA))


# EWMA volatility

lambda <- 0.94

ewma_vol <- numeric(length(HSBC_data$log_return))
ewma_vol[1] <- sd(HSBC_data$log_return[1:W])

for (t in 2:length(ewma_vol)){
  ewma_vol[t] <- sqrt((1 - lambda)* HSBC_data$log_return[t-1]^2 + lambda * ewma_vol[t-1]^2)
}

HSBC_data$EWMA_vol <- ewma_vol

ggplot(HSBC_data, aes(x = date)) +
  geom_line(aes(y = MA_vol, color = "MA(21) Volatility")) +
  geom_line(aes(y = EWMA_vol, color = "EWMA(0.94) Volatility")) +
  labs(title = "HSBC: MA vs. EWMA Volatility", x = "Date", y = "Volatility", color = "Model") +
  theme_minimal()
```

## b.
```{r echo=TRUE, fig.dim=c(5,4), fig.align='center'}

# calculate standrized residuals
HSBC_data <- HSBC_data %>%
  mutate(resid_MA = log_return / MA_vol,
         resid_EWMA = log_return / EWMA_vol)

# Ljung-Box Test

# residual autocorrelation checking
Box.test(HSBC_data$resid_MA, lag = 30, type = "Ljung-Box")
Box.test(HSBC_data$resid_EWMA, lag = 30, type = "Ljung-Box")

# squared residual autocorrelation checking/cluster
Box.test(HSBC_data$resid_MA^2, lag = 20, type = "Ljung-Box")
Box.test(HSBC_data$resid_EWMA^2, lag = 20, type = "Ljung-Box")

# plot acf
par(mfrow = c(2, 2))
acf(na.omit(HSBC_data$resid_MA), main = "ACF of MA Residuals", ylim = c(-0.2, 0.2))
acf(na.omit(HSBC_data$resid_MA^2), main = "ACF of MA Aquared Residuals", ylim = c(-0.2, 0.2))
acf(na.omit(HSBC_data$resid_EWMA), main = "ACF of EWMA Residuals", ylim = c(-0.2, 0.2))
acf(na.omit(HSBC_data$resid_EWMA^2), main = "ACF of EWMA Squared Residuals", ylim = c(-0.2, 0.2))

```