---
title: "EF Group Submission Assignment 2"
subtitle: "Group 15" 
author: "Lanlan Hou (2801069), Rick van der Ploeg (2782774), Sebastiaan van Dijen (2769505) and Alfred Sou (2796840)"
output: pdf_document
---

# Question 1

## a.
```{r echo=TRUE,fig.dim=c(5,4),fig.align='center'}
library(openxlsx)
raw <- read.xlsx('student_groups_stocks.xlsx', sheet = 1)

groupNumber <- 15
nameOfStock <- raw$Stock.Name[groupNumber]
startDate <- raw$Start.Date[groupNumber]
endDate <- raw$`End.Date.(+10y)`[groupNumber]

# Compute the start date of the final five years
library(lubridate)

originalDate <- as.Date(startDate)
finalFiveYearsStartDate <- originalDate %m+% years(5)

# Extract the daily stock price from source
library(quantmod)

getSymbols(nameOfStock, src = 'yahoo', from = finalFiveYearsStartDate, to = endDate)
date <- index(HSBC)

# Adjusted Close
adjustedPrice <- as.numeric(HSBC[,'HSBC.Adjusted'])

# Log Returns
compoundedReturns <- numeric(length(adjustedPrice) - 1)
for(i in (2:length(adjustedPrice))){
  compoundedReturns[i-1] <- log(adjustedPrice[i] / adjustedPrice[i-1])
}
# Squared Log Returns
squaredCompoundedReturns <- compoundedReturns ^ 2

# Function to compute the ACF and plot the graph
plotACF <- function(input_list, input_maxLags, objectName, savePath) {
  ACFResult <- acf(input_list, lag.max = input_maxLags, plot = FALSE)
  
  ACFValues <- ACFResult$acf[-1]
  lags <- ACFResult$lag[-1]
  numberOfObservations <- length(input_list)
  confidenceBands <- 1.96 * 1 / sqrt(length(input_list))
  
  library(ggplot2)
  plot_df <- data.frame(lag = lags, acf = ACFValues)
  
  ggplot(plot_df, aes(x = lag, y = acf)) +
    geom_bar(aes(color = 'ACF'), stat = 'identity', 
             fill ='blue', width = 0.05) +
    geom_hline(yintercept = 0, color = 'black') +
    geom_hline(aes(yintercept = -confidenceBands, 
               color = '95% Confidence Interval'), linetype = 'dashed') + 
    geom_hline(aes(yintercept = confidenceBands, 
               color = '95% Confidence Interval'), linetype = 'dashed') +
    scale_color_manual(name = 'Components',
                       values = c('ACF' = 'blue',
                                  '95% Confidence Interval' = 'red')) +
    labs(title = paste('ACF for HSBC', objectName, 'for', input_maxLags, 'Lags (2015M11-2020M11)'), 
         x = 'Lag', y = 'ACF') +
    theme_minimal() +
    theme(legend.position = c(0.95, 0.95),
          legend.justification = c("right", "top"),
          legend.title = element_text(size = 12, face = "bold"),
          legend.text = element_text(size = 10))
  ggsave(savePath, width = 10, height = 6, dpi = 300)
}

returns_result <- plotACF(compoundedReturns, 
                  input_maxLags = 50,
                  objectName = 'Log Returns', 
                  savePath = 'figures/returns_acf_plot.png')

squaredReturns_result <- plotACF(squaredCompoundedReturns, 
                                 input_maxLags = 50,
                                 objectName = 'Squared Log Returns', 
                                 savePath = 'figures/squaredReturns_acf_plot.png')
```

## b.
```{r echo=TRUE,fig.dim=c(5,4),fig.align='center'}
# Function to perform the Ljung-Box test and report the result
LBTest <- function(input_series, input_maxLags, steps){
  steppedLags <- seq(steps, input_maxLags, by = steps)
  
  result_df <- data.frame(Lag = integer(),
                          Statistic = numeric(),
                          Crit_Value = numeric(),
                          P_Value = numeric())
  
  for (lag in steppedLags) {
    lb_test <- Box.test(input_series, lag = lag, type = 'Ljung-Box')
    testStatistic <- as.numeric(lb_test$statistic)
    pValue <- as.numeric(lb_test$p.value)
    criticalValue <- qchisq(0.95, df = lag)
  
    newRow <- data.frame(Lag = lag, 
                         Statistic = round(testStatistic, 4),
                         Critical_Value = round(criticalValue, 4),
                         P_Value = signif(pValue, 4))
    
    result_df <- rbind(result_df,newRow)
  }
  return(result_df)
}

returns_LBTest <- LBTest(compoundedReturns, 50, 10)
returns_LBTest
returns_LBTest <- LBTest(squaredCompoundedReturns, 50, 10)
returns_LBTest
```

# Question 2

## a.
```{r echo=TRUE, fig.dim=c(5,4),fig.align='center'}
single_logReturns_df <- data.frame(compoundedReturns = compoundedReturns)

# Distribution Plot of daily log returns with equivalent normal distribution curve
ggplot(single_logReturns_df, aes(x = compoundedReturns)) +
  geom_histogram(aes(y = ..density..), 
                 bins = 50, fill = 'skyblue', color = 'white') +
  geom_density(aes(color = 'Empirical distribution'), size = 1) +
  stat_function(fun = dnorm,
                args = list(mean = mean(single_logReturns_df$compoundedReturns, na.rm = TRUE),
                            sd = sd(single_logReturns_df$compoundedReturns, na.rm = TRUE)),
                aes(color = 'Normal distribution'),
                linewidth = 1.5, linetype = 'dashed') +
  scale_color_manual(
    name = 'Distributions',
    values = c('Empirical distribution' = 'navy',
               'Normal distribution'   = 'orange')) +
  labs(title = 'Distribution of HSBC Daily Log Returns',
       x = 'Log Returns', y = 'Density') +
  theme_minimal() +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(size = 12, face = 'bold'),
    legend.text = element_text(size = 10))
ggsave('figures/returns_distribution.png', dpi = 300)
```

## b.
```{r echo=TRUE, fig.dim=c(12,8)}
# Perform Jarque-Bera normality test
library(tseries)
jb_test <- jarque.bera.test(compoundedReturns)
jb_test

# Show the results of the JB test
jbTest_summaryStatistics <- data.frame(
  JB_Test_Statistic = round(jb_test$statistic, 2),
  Critical_Value = round(qchisq(0.95, 2), 2),
  p_Value = round(jb_test$p.value, 2) 
)

jbTest_summaryStatistics

# QQ Plot of daily log returns
ggplot(single_logReturns_df, aes(sample = compoundedReturns)) +
  stat_qq(shape = 1, color = 'blue', size = 1) +
  stat_qq_line(color = 'red', linewidth = 1) +
  labs(title = 'QQ Plot for HSBC Log Returns',
       x = 'Theoretical Quantiles', y = 'Sample Quantiles') +
  theme_minimal()
ggsave('figures/returns_qqplot.png', dpi = 300)
```